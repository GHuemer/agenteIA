<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat Bot (single-file)</title>
  <style>
    :root {
      --bg: #0f1115;
      --panel: #151923;
      --muted: #7c8596;
      --text: #e7eaf0;
      --accent: #4ade80;
      --danger: #f87171;
      --bubble-ai: #1a2030;
      --bubble-user: #22304a;
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font: 15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: radial-gradient(1200px 800px at 80% -10%, #182030 0%, var(--bg) 60%);
      display: grid;
      grid-template-rows: auto 1fr auto;
    }
    header {
      padding: 14px 16px;
      border-bottom: 1px solid #202636;
      background: linear-gradient(180deg, #121622, #0f1115);
      display: flex; align-items: center; gap: 10px;
      position: sticky; top: 0; z-index: 5;
    }
    header .dot { width: 10px; height: 10px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 12px var(--accent); }
    header h1 { font-size: 14px; margin: 0; color: #cfd6e6; font-weight: 600; letter-spacing: .3px; }

    #chat {
      padding: 18px;
      overflow-y: auto;
      display: flex; flex-direction: column; gap: 12px;
    }

    .msg {
      display: grid;
      grid-template-columns: 34px 1fr;
      gap: 10px;
      align-items: flex-start;
      animation: fadeIn .12s ease-out;
    }
    .avatar {
      width: 34px; height: 34px; border-radius: 50%;
      display: grid; place-items: center;
      font-weight: 700; font-size: 12px;
      background: #1f2533; color: #9fb3ff;
      user-select: none;
    }
    .avatar.user { background: #25324a; color: #a7f3d0; }
    .bubble {
      background: var(--bubble-ai);
      border: 1px solid #242b3d;
      padding: 12px 14px;
      border-radius: var(--radius);
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .user .bubble { background: var(--bubble-user); }
    .meta {
      margin-top: 6px; font-size: 12px; color: var(--muted);
    }

    #composer {
      padding: 10px 12px;
      border-top: 1px solid #1d2331;
      background: #0f121a;
    }
    form {
      display: grid; grid-template-columns: 1fr auto; gap: 10px;
      max-width: 900px; margin: 0 auto;
    }
    textarea {
      resize: vertical;
      min-height: 48px; max-height: 180px;
      width: 100%;
      padding: 12px 12px 12px 14px;
      color: var(--text);
      background: var(--panel);
      border: 1px solid #242b3d;
      outline: none;
      border-radius: var(--radius);
    }
    textarea:focus { border-color: #3556ff66; box-shadow: 0 0 0 3px #3556ff22; }
    button {
      padding: 0 16px;
      border: 1px solid #2b344a;
      border-radius: var(--radius);
      background: linear-gradient(180deg, #1e2638, #141a28);
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      min-width: 110px;
    }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    .hint {
      text-align: center; font-size: 12px; color: var(--muted); margin-top: 8px;
    }
    .err { color: var(--danger); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px);} to { opacity: 1; transform: none;} }
  </style>
</head>
<body>
  <header>
    <div class="dot" aria-hidden="true"></div>
    <h1>Chat Bot (sessão volátil – recarregar limpa a conversa)</h1>
  </header>

  <main id="chat" aria-live="polite" aria-label="Histórico do chat">
    <!-- Mensagem inicial -->
    <div class="msg ai">
      <div class="avatar">AI</div>
      <div>
        <div class="bubble">Olá! Sou um chat super simples. Envie sua pergunta e vou consultar <code>ask()</code>.</div>
        <div class="meta">Pronto para conversar.</div>
      </div>
    </div>
  </main>

  <div id="composer">
    <form id="form">
      <textarea id="input" placeholder="Escreva sua mensagem... (Shift+Enter = nova linha)" autocomplete="off"></textarea>
      <button id="send" type="submit">Enviar</button>
    </form>
    <div class="hint">Este chat não tem memória persistente. Ao recarregar a página, o histórico é perdido.</div>
  </div>

  <script>
    async function callAskEndpoint(message) {
  // 1) Função global ask() - pode ignorar isto
  if (typeof window.ask === 'function') {
    const res = await window.ask(message);
    return typeof res === 'string' ? res : (res && res.answer) || '';
  }
  
  // 2) Fallback HTTP: POST /api/ask (CORRIGIDO)
  const r = await fetch('/api/ask', { // <--- A alteração está aqui
    method: 'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify({ question: message })
  });

  if (!r.ok) {
    const text = await r.text().catch(() => '');
    throw new Error(`Falha no endpoint /api/ask (${r.status}): ${text || r.statusText}`);
  }

  const data = await r.json().catch(() => ({}));
  if (!data || typeof data.answer !== 'string') {
    // Se a resposta não tiver "answer", mostra o JSON completo para depuração
    return `Resposta inesperada: ${JSON.stringify(data)}`;
  }
  return data.answer;
}

    // === UI helpers ===========================================================
    const chat = document.getElementById('chat');
    const form = document.getElementById('form');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send');

    function addMessage(role, text, meta) {
      const wrapper = document.createElement('div');
      wrapper.className = `msg ${role}`;
      const avatar = document.createElement('div');
      avatar.className = `avatar ${role === 'user' ? 'user' : ''}`;
      avatar.textContent = role === 'user' ? 'Você' : 'AI';
      const body = document.createElement('div');
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = text; // plain text (sem markdown)
      body.appendChild(bubble);
      if (meta) {
        const m = document.createElement('div');
        m.className = 'meta';
        m.textContent = meta;
        body.appendChild(m);
      }
      wrapper.appendChild(avatar);
      wrapper.appendChild(body);
      chat.appendChild(wrapper);
      chat.scrollTop = chat.scrollHeight;
      return bubble; // retorna a bolha (útil para editar "digitando...")
    }

    function setPending(pending) {
      input.disabled = pending;
      sendBtn.disabled = pending;
      if (pending) sendBtn.textContent = 'Enviando...';
      else sendBtn.textContent = 'Enviar';
    }

    // Shift+Enter => nova linha; Enter => enviar
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        form.requestSubmit();
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const message = (input.value || '').trim();
      if (!message) return;
      addMessage('user', message);
      input.value = '';
      input.style.height = 'auto';

      // Placeholder "digitando…"
      const thinking = addMessage('ai', 'Digitando…');

      try {
        setPending(true);
        const answer = await callAskEndpoint(message);
        thinking.textContent = answer || '(resposta vazia)';
      } catch (err) {
        thinking.textContent = 'Ocorreu um erro ao consultar o endpoint.';
        thinking.insertAdjacentHTML('afterend', `<div class="meta err">${(err && err.message) || err}</div>`);
      } finally {
        setPending(false);
        chat.scrollTop = chat.scrollHeight;
      }
    });

    // Auto-expand do textarea
    const autoGrow = () => {
      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 180) + 'px';
    };
    input.addEventListener('input', autoGrow);
    autoGrow();
  </script>
</body>
</html>




